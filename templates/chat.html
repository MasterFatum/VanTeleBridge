<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <title>Tuco Chat</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            margin-top: 20px;
            background-color: #1565c0;
            color: white;
            margin: 0;
            padding: 0;
        }
        .video-container {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 20px auto;
            max-width: 1400px;
            flex-wrap: nowrap;
            flex-direction: row;
            align-items: center;
            overflow: hidden;
        }
        .video-box {
            width: 640px;
            height: 480px;
            border: 2px solid #0d47a1;
            border-radius: 12px;
            overflow: hidden;
            background-color: #42a5f5;
            box-shadow: 0 6px 12px rgba(0,0,0,0.3);
            position: relative;
            flex: 1 1 640px;
        }
        .video-box video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .video-label {
            position: absolute;
            top: 10px;
            left: 10px;
            background-color: rgba(0, 0, 0, 0.6);
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 14px;
            z-index: 10;
            font-weight: bold;
        }
        h1 {
            color: #ffffff;
            text-shadow: 1px 1px 3px rgba(0,0,0,0.5);
        }
        button {
            padding: 10px 20px;
            font-size: 16px;
            margin: 5px;
            background-color: #1976d2;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        button:hover {
            background-color: #1565c0;
        }
        .controls {
            margin: 15px;
        }
        #status {
            color: #bbdefb;
            font-size: 16px;
            margin-top: 10px;
        }
        #timer {
            font-size: 18px;
            font-weight: bold;
            color: #4fc3f7;
            margin: 5px;
        }

        /* –ê–Ω–∏–º–∞—Ü–∏—è –ø–æ–∏—Å–∫–∞ */
        .loading {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #4fc3f7;
            margin: 0 4px;
            animation: blink 1.4s infinite both;
        }
        .loading:nth-child(2) { animation-delay: 0.2s; }
        .loading:nth-child(3) { animation-delay: 0.4s; }

        @keyframes blink {
            0%, 80%, 100% { opacity: 0; }
            40% { opacity: 1; }
        }

        .loading-container {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-style: italic;
            color: #4fc3f7;
        }

        /* –°—Ç–∏–ª—å –≤—ã–ø–∞–¥–∞—é—â–µ–≥–æ —Å–ø–∏—Å–∫–∞ —Å—Ç—Ä–∞–Ω */
        .country-select {
            padding: 8px 12px;
            font-size: 16px;
            border-radius: 5px;
            border: 1px solid #1976d2;
            background-color: white;
            color: #000;
            margin: 0 5px;
            cursor: pointer;
        }
        .country-select:focus {
            outline: none;
            box-shadow: 0 0 5px rgba(25, 118, 210, 0.5);
        }
    </style>
</head>
<body>
    <h1>Tuco Chat</h1>

    <div class="video-container">
        <div class="video-box">
            <video id="localVideo" autoplay muted></video>
            <div class="video-label">–í—ã</div>
        </div>
        <div class="video-box">
            <video id="remoteVideo" autoplay></video>
            <div class="video-label">–°–æ–±–µ—Å–µ–¥–Ω–∏–∫</div>
        </div>
    </div>

    <div class="controls">
        <div style="margin: 10px 0;">
            <label>
                <input type="radio" name="gender" value="any" checked> –õ—é–±–æ–π –ø–æ–ª
            </label>
            <label>
                <input type="radio" name="gender" value="male"> –ú—É–∂—á–∏–Ω–∞
            </label>
            <label>
                <input type="radio" name="gender" value="female"> –ñ–µ–Ω—â–∏–Ω–∞
            </label>
        </div>

        <!-- –í—ã–ø–∞–¥–∞—é—â–∏–π —Å–ø–∏—Å–æ–∫ —Å—Ç—Ä–∞–Ω -->
        <div style="margin: 10px 0;">
            <label for="country">–°—Ç—Ä–∞–Ω–∞ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞:</label>
            <select id="country" class="country-select" name="country">
                <option value="any">–õ—é–±–∞—è —Å—Ç—Ä–∞–Ω–∞</option>
                <option value="ru">–†–æ—Å—Å–∏—è</option>
                <option value="ua">–£–∫—Ä–∞–∏–Ω–∞</option>
                <option value="kz">–ö–∞–∑–∞—Ö—Å—Ç–∞–Ω</option>
                <option value="by">–ë–µ–ª–∞—Ä—É—Å—å</option>
                <option value="uz">–£–∑–±–µ–∫–∏—Å—Ç–∞–Ω</option>
                <option value="az">–ê–∑–µ—Ä–±–∞–π–¥–∂–∞–Ω</option>
                <option value="md">–ú–æ–ª–¥–æ–≤–∞</option>
                <option value="ge">–ì—Ä—É–∑–∏—è</option>
                <option value="am">–ê—Ä–º–µ–Ω–∏—è</option>
                <option value="lt">–õ–∏—Ç–≤–∞</option>
                <option value="lv">–õ–∞—Ç–≤–∏—è</option>
                <option value="ee">–≠—Å—Ç–æ–Ω–∏—è</option>
            </select>
        </div>

        <button onclick="toggleSearch()" id="findButton">üîç –ü–æ–∏—Å–∫ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞</button>
        <button onclick="toggleMicrophone()" id="micButton">üé§ –ú–∏–∫—Ä–æ—Ñ–æ–Ω: –í–∫–ª</button>
        <button onclick="toggleRemoteAudio()" id="audioButton">üîä –ó–≤—É–∫: –í–∫–ª</button>
        <button onclick="hangup()" id="hangupButton" style="display: none;">üìû –ó–∞–≤–µ—Ä—à–∏—Ç—å</button>
        <div id="status">üé• –ö–∞–º–µ—Ä–∞ –≤–∫–ª—é—á–∞–µ—Ç—Å—è...</div>
        <div id="timer" style="display: none;">‚è± –í—Ä–µ–º—è —Ä–∞–∑–≥–æ–≤–æ—Ä–∞: 00:00</div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.min.js"></script>
    <script>
        const localVideo = document.getElementById('localVideo');
        const remoteVideo = document.getElementById('remoteVideo');
        const findButton = document.getElementById('findButton');
        const hangupButton = document.getElementById('hangupButton');
        const micButton = document.getElementById('micButton');
        const audioButton = document.getElementById('audioButton');
        const statusDiv = document.getElementById('status');
        const timerDiv = document.getElementById('timer');
        const countrySelect = document.getElementById('country');

        let localStream;
        let remoteStream;
        let peerConnection;
        let socket;

        let isMicrophoneEnabled = true;
        let isRemoteAudioEnabled = true;

        let timerInterval = null;
        let startTime = null;

        let isSearching = false;

        const servers = {
            iceServers: [
                { urls: 'stun:stun.l.google.com:19302' }
            ]
        };

        window.addEventListener('load', () => {
            getLocalStream();
        });

        async function getLocalStream() {
            try {
                if (!localStream) {
                    statusDiv.innerText = 'üé• –†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ –∏ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É...';
                    localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                    localVideo.srcObject = localStream;
                    statusDiv.innerText = '‚úÖ –ö–∞–º–µ—Ä–∞ –≤–∫–ª—é—á–µ–Ω–∞. –ù–∞–∂–º–∏—Ç–µ ¬´–ü–æ–∏—Å–∫ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞¬ª, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å.';
                    isMicrophoneEnabled = true;
                    localStream.getAudioTracks().forEach(track => {
                        track.enabled = true;
                    });
                    updateMicButton();
                }
            } catch (err) {
                statusDiv.innerText = '‚ùå –û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ: —Ä–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø';
                findButton.disabled = false;
                console.error('getUserMedia error:', err);
            }
        }

        function updateMicButton() {
            if (isMicrophoneEnabled) {
                micButton.innerHTML = 'üé§ –ú–∏–∫—Ä–æ—Ñ–æ–Ω: –í–∫–ª';
                micButton.style.background = '#1976d2';
            } else {
                micButton.innerHTML = 'üö´ –ú–∏–∫—Ä–æ—Ñ–æ–Ω: –í—ã–∫–ª';
                micButton.style.background = '#d32f2f';
            }
        }

        function toggleSearch() {
            if (isSearching) {
                stopSearch();
            } else {
                startSearch();
            }
        }

        function startSearch() {
            if (!localStream) {
                statusDiv.innerText = '‚ùå –°–Ω–∞—á–∞–ª–∞ —Ä–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ!';
                return;
            }
            findButton.disabled = true;
            statusDiv.innerHTML = '<div class="loading-container">–ü–æ–∏—Å–∫ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞<span class="loading"></span><span class="loading"></span><span class="loading"></span></div>';
            findButton.innerHTML = 'üõë –ó–∞–≤–µ—Ä—à–∏—Ç—å –ø–æ–∏—Å–∫';
            findButton.style.background = '#d32f2f';
            isSearching = true;

            connectAndFindPartner();
        }

        function stopSearch() {
            if (socket) {
                socket.off('connect_with');
                socket.off('status');
                socket.disconnect();
                console.log('–ü–æ–∏—Å–∫ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω. –°–æ–∫–µ—Ç –æ—Ç–∫–ª—é—á—ë–Ω.');
            }
            socket = null;
            statusDiv.innerText = 'üîç –ü–æ–∏—Å–∫ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω.';
            findButton.innerHTML = 'üîç –ü–æ–∏—Å–∫ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞';
            findButton.style.background = '';
            findButton.disabled = false;
            isSearching = false;
        }

        function connectAndFindPartner() {
            socket = io('https://127.0.0.1:5000', { secure: true });

            const selectedGender = document.querySelector('input[name="gender"]:checked').value;
            const selectedCountry = countrySelect.value;

            socket.on('status', (msg) => {
                statusDiv.innerText = msg;
            });

            socket.on('connect_with', (data) => {
                statusDiv.innerText = '‚úÖ –°–æ–±–µ—Å–µ–¥–Ω–∏–∫ –Ω–∞–π–¥–µ–Ω!';
                hangupButton.style.display = 'inline-block';
                timerDiv.style.display = 'block';
                startTimer();
                startCall(data.target);
                isSearching = false;
                findButton.innerHTML = 'üîç –ü–æ–∏—Å–∫ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞';
                findButton.style.background = '';
                findButton.disabled = true;
            });

            socket.emit('find_partner', {
                gender: selectedGender,
                country: selectedCountry
            });
        }

        function startTimer() {
            startTime = new Date();
            clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                const now = new Date();
                const diff = new Date(now - startTime);
                const min = String(diff.getUTCMinutes()).padStart(2, '0');
                const sec = String(diff.getUTCSeconds()).padStart(2, '0');
                timerDiv.innerText = `‚è± –í—Ä–µ–º—è —Ä–∞–∑–≥–æ–≤–æ—Ä–∞: ${min}:${sec}`;

                if (now - startTime >= 12 * 60 * 1000) {
                    statusDiv.innerText = '‚è∞ –í—Ä–µ–º—è —Ä–∞–∑–≥–æ–≤–æ—Ä–∞ –∏—Å—Ç–µ–∫–ª–æ. –ü–æ–∏—Å–∫ –Ω–æ–≤–æ–≥–æ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞...';
                    hangup();
                    setTimeout(() => {
                        if (!isSearching) toggleSearch();
                    }, 2000);
                }
            }, 1000);
        }

        function resetTimer() {
            clearInterval(timerInterval);
            timerInterval = null;
            timerDiv.innerText = '‚è± –í—Ä–µ–º—è —Ä–∞–∑–≥–æ–≤–æ—Ä–∞: 00:00';
            timerDiv.style.display = 'none';
        }

        async function startCall(targetSid) {
            peerConnection = new RTCPeerConnection(servers);
            remoteStream = new MediaStream();
            remoteVideo.srcObject = remoteStream;

            localStream.getTracks().forEach(track => {
                peerConnection.addTrack(track, localStream);
            });

            peerConnection.ontrack = (event) => {
                event.streams[0].getTracks().forEach(track => {
                    remoteStream.addTrack(track);
                });
            };

            peerConnection.onicecandidate = (event) => {
                if (event.candidate) {
                    socket.emit('signal', {
                        target: targetSid,
                        payload: { type: 'ice', candidate: event.candidate }
                    });
                }
            };

            try {
                const offer = await peerConnection.createOffer();
                await peerConnection.setLocalDescription(offer);
                socket.emit('signal', {
                    target: targetSid,
                    payload: { type: 'offer', sdp: offer }
                });
            } catch (err) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ offer:', err);
            }
        }

        async function handleSignal(data) {
            if (!peerConnection) return;

            try {
                if (data.type === 'offer') {
                    await peerConnection.setRemoteDescription(new RTCSessionDescription(data.sdp));
                    const answer = await peerConnection.createAnswer();
                    await peerConnection.setLocalDescription(answer);
                    socket.emit('signal', {
                        target: null,
                        payload: { type: 'answer', sdp: answer }
                    });
                } else if (data.type === 'answer') {
                    await peerConnection.setRemoteDescription(new RTCSessionDescription(data.sdp));
                } else if (data.type === 'ice') {
                    await peerConnection.addIceCandidate(new RTCIceCandidate(data.candidate));
                }
            } catch (err) {
                console.error('–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–∏–≥–Ω–∞–ª–∞:', err);
            }
        }

        function toggleMicrophone() {
            if (!localStream) return;

            isMicrophoneEnabled = !isMicrophoneEnabled;
            localStream.getAudioTracks().forEach(track => {
                track.enabled = isMicrophoneEnabled;
            });
            updateMicButton();
        }

        function toggleRemoteAudio() {
            if (!remoteVideo.srcObject) return;

            isRemoteAudioEnabled = !isRemoteAudioEnabled;
            remoteVideo.muted = !isRemoteAudioEnabled;

            if (isRemoteAudioEnabled) {
                audioButton.innerHTML = 'üîä –ó–≤—É–∫: –í–∫–ª';
                audioButton.style.background = '#1976d2';
            } else {
                audioButton.innerHTML = 'üîá –ó–≤—É–∫: –í—ã–∫–ª';
                audioButton.style.background = '#d32f2f';
            }
        }

        function hangup() {
            if (peerConnection) {
                peerConnection.close();
                peerConnection = null;
            }
            if (socket) {
                socket.disconnect();
                socket = null;
            }

            remoteVideo.srcObject = null;

            hangupButton.style.display = 'none';
            findButton.disabled = false;
            statusDiv.innerText = 'üëã –°–æ–±–µ—Å–µ–¥–Ω–∏–∫ –æ—Ç–∫–ª—é—á—ë–Ω.';
            resetTimer();
        }
    </script>
</body>
</html>